{% extends 'main.html' %}

{% block content %}
<div class="min-h-[70vh] flex items-center justify-center px-4 py-12">
  <div class="w-full max-w-xl bg-white/90 dark:bg-slate-900/90 backdrop-blur-md rounded-2xl shadow-lg border border-slate-200 dark:border-slate-800 p-8">
    <div class="flex items-start gap-4">
      <svg class="w-12 h-12 text-green-600 shrink-0" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M12 1.75a6.5 6.5 0 0 1 6.5 6.5v3.5a6.5 6.5 0 0 1-13 0V8.25A6.5 6.5 0 0 1 12 1.75z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8.75 13.75a3.25 3.25 0 0 0 6.5 0" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>

      <div class="flex-1">
        <h1 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Set a new password</h1>
        <p class="mt-1 text-sm text-slate-500 dark:text-slate-300">Choose a strong password for your account at <span class="font-medium">Gobnimo Marketplace</span>.</p>
      </div>
    </div>

    {# Invalid/expired link message (non-field errors) #}
    {% if form.non_field_errors %}
    <div class="mt-6 p-4 rounded-md bg-yellow-50 border border-yellow-200 text-yellow-800">
      {{ form.non_field_errors }}
    </div>
    {% endif %}

    {# Field errors (global) #}
    {% if form.errors %}
    <div class="mt-4 p-3 rounded-md bg-rose-50 border border-rose-100 text-rose-700">
      <strong class="block font-medium mb-1">Please fix the following:</strong>
      <ul class="ml-4 list-disc text-sm">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <form method="POST" class="mt-6 space-y-5">
      {% csrf_token %}

      <!-- New password -->
      <div>
        <label for="{{ form.new_password1.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200">
          New password
        </label>
        <div class="mt-1 relative">
          {{ form.id_new_password1 }}
          <!-- Show/Hide toggle -->
          <button type="button"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-sm px-3 py-1 rounded-md bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200"
                  aria-pressed="false"
                  id="togglePwd1"
                  onclick="togglePassword('id_new_password1', 'togglePwd1')">
            Show
          </button>
        </div>
        {% if form.new_password1.help_text %}
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">{{ form.new_password1.help_text|safe }}</p>
        {% endif %}

        <!-- Strength meter -->
        <div class="mt-3">
          <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
            <div id="pwdStrengthBar" class="h-2 w-0 rounded-full transition-all"></div>
          </div>
          <p id="pwdStrengthText" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Password strength: <span class="font-medium">â€”</span></p>
        </div>
      </div>

      <!-- Confirm password -->
      <div>
        <label for="{{ form.new_password2.id_for_label }}" class="block text-sm font-medium text-slate-700 dark:text-slate-200">
          Confirm new password
        </label>
        <div class="mt-1 relative">
          {{ form.new_password2 }}
          <button type="button"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-sm px-3 py-1 rounded-md bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200"
                  aria-pressed="false"
                  id="togglePwd2"
                  onclick="togglePassword('id_new_password2', 'togglePwd2')">
            Show
          </button>
        </div>
      </div>

      <div>
        <button type="submit"
                class="w-full inline-flex items-center justify-center gap-2 rounded-lg py-3 text-white font-semibold focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-green-500"
                style="background: linear-gradient(90deg,#059669 0%, #10b981 100%);">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7"></path>
          </svg>
          Change password
        </button>
      </div>

      <p class="text-center text-sm text-slate-500 dark:text-slate-400">
        Remembered your password? <a href="{% url 'login' %}" class="font-medium text-green-600 hover:underline">Sign in</a>
      </p>
    </form>
  </div>
</div>

{# Inline JS: small helpers (no external libs) #}
<script>
  // Toggle password visibility for input id (expects Django default ids like 'id_new_password1')
  function togglePassword(inputId, btnId) {
    const inp = document.getElementById(inputId);
    const btn = document.getElementById(btnId);
    if (!inp) return;
    if (inp.type === 'password') {
      inp.type = 'text';
      btn.textContent = 'Hide';
      btn.setAttribute('aria-pressed', 'true');
    } else {
      inp.type = 'password';
      btn.textContent = 'Show';
      btn.setAttribute('aria-pressed', 'false');
    }
  }

  // Password strength: simple scoring by length + variety (numbers, lower/upper, symbols)
  const pwdInput = document.getElementById('id_new_password1');
  const bar = document.getElementById('pwdStrengthBar');
  const text = document.getElementById('pwdStrengthText');

  function scorePassword(pw) {
    let score = 0;
    if (!pw) return 0;
    if (pw.length >= 8) score += 1;
    if (pw.length >= 12) score += 1;
    if (/[a-z]/.test(pw) && /[A-Z]/.test(pw)) score += 1;
    if (/\d/.test(pw)) score += 1;
    if (/[^A-Za-z0-9]/.test(pw)) score += 1;
    return score; // 0..5
  }

  function updateStrength() {
    if (!pwdInput) return;
    const s = scorePassword(pwdInput.value);
    const pct = (s / 5) * 100;
    bar.style.width = pct + '%';

    // color choices (tailwind-ish)
    if (s <= 1) {
      bar.style.backgroundColor = '#ef4444'; // red
      text.innerHTML = 'Password strength: <span class="font-medium text-rose-600">Very weak</span>';
    } else if (s === 2) {
      bar.style.backgroundColor = '#f59e0b'; // amber
      text.innerHTML = 'Password strength: <span class="font-medium text-amber-600">Weak</span>';
    } else if (s === 3) {
      bar.style.backgroundColor = '#fbbf24'; // yellow
      text.innerHTML = 'Password strength: <span class="font-medium text-yellow-600">Okay</span>';
    } else if (s === 4) {
      bar.style.backgroundColor = '#10b981'; // green
      text.innerHTML = 'Password strength: <span class="font-medium text-green-600">Good</span>';
    } else {
      bar.style.backgroundColor = '#059669'; // strong green
      text.innerHTML = 'Password strength: <span class="font-medium text-emerald-600">Strong</span>';
    }
  }

  if (pwdInput) {
    pwdInput.addEventListener('input', updateStrength);
    // initialize on load
    updateStrength();
  }
</script>
{% endblock %}
