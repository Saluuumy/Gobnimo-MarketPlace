{% extends 'main.html' %}
{% load static %}

{% block content %}
<body class="antialiased overflow-x-hidden"> <!-- <- prevent page-level horizontal scroll -->
    <!-- content -->
  <main class="site-main relative ml-0 md:ml-[62px] min-w-0 flex-1 overflow-auto p-3 md:p-6 scrollbar-thin">
<section class="mb-4 md:mb-6 mobile-negative-margin" style="margin-top: 42px">
          <div class="flex items-center justify-between">
          <h2 class="text-lg md:text-2xl font-semibold">Advanced Search</h2>
      
        </div>

        <div class="mt-3 md:mt-4 flex flex-wrap gap-2 items-center">
          <input id="filterInput" class="rounded-md bg-slate-800 px-2 py-2 w-48 md:w-64 placeholder:text-[color:var(--muted)] text-sm" placeholder="Type to filter" />
          <div class="flex gap-2 flex-wrap">
            <button id="sortButton" class="px-2 py-1 rounded-full bg-[color:var(--chip)] text-[color:var(--muted)] text-xs md:text-sm">Display name ▾</button>
       </div>
    <div class="ml-auto text-xs md:text-sm text-[color:var(--muted)] flex items-center gap-3">
    <span>Showing <strong id="assetCount">{{ featured_products|length }}</strong> assets</span>   

        </div>
        </div>
      </section>

      <!-- Categories and Products Grid -->
      <section class="categories-section py-6 px-4 relative z-0">
        <div class="container mx-auto max-w-6xl">
          {% for category in categories %}
            {% if category.approved_ads %}
            <div class="mb-10 category-section" data-category-name="{{ category.name|lower }}">
              <div class="flex justify-between items-center mb-5">
                <h3 class="text-xl font-bold text-white category-header pl-3">{{ category.name }}</h3>
              </div>

              <!-- Horizontal scroll container -->
              <div class="relative">
                <div class="category-scroll-container overflow-x-auto pb-4 scrollbar-thin scrollbar-thumb-slate-600 scrollbar-track-slate-800" data-category-id="{{ category.id }}">
                  <div class="flex space-x-5 min-w-max px-2">
                    {% for product in category.approved_ads %}
                    <article class="asset-card bg-slate-800 rounded-lg shadow-md overflow-hidden border border-slate-700 flex-shrink-0 w-64" data-name="{{ product.name|lower }}" data-category="{{ product.category.name|default:''|lower }}" data-location="{{ product.location|default:''|lower }}">
                      <a href="{% url 'product_detail' product.id %}">
                        <div class="product-image-container relative h-40">
                          {% if product.images.first %}
                          <img src="{{ product.images.first.image.url }}" alt="{{ product.name }} - {{ product.location }} - ${{ product.price }}" class="product-image w-full h-full object-cover" loading="lazy" draggable="false">
                          {% else %}
                          <div class="product-placeholder w-full h-full bg-slate-700 flex items-center justify-center">
                            <i class="fas fa-image text-4xl text-slate-500"></i>
                          </div>
                          {% endif %}

                          {% if product.is_featured %}
                          <span class="absolute top-2 left-2 bg-pink-500 text-white text-xs font-bold px-2 py-1 rounded">Featured</span>
                          {% endif %}

                          <span class="absolute top-2 right-2 bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded">${{ product.price }}</span>
                        </div>
                      </a>
                      
                      <div class="p-4">
                        <div class="flex items-start justify-between gap-3">
                          <div class="w-full">
                            <h3 class="font-semibold text-white mb-1 product-name">{{ product.name }}</h3>
                            <div class="text-xs text-slate-400 mb-2">
                              <i class="fas fa-map-marker-alt mr-1"></i>{{ product.location|default:"No location" }}
                            </div>
                            <div class="text-xs text-slate-400 mb-3">
                              <i class="far fa-clock mr-1"></i>{{ product.created_at|timesince }} ago
                            </div>
                            <div class="mt-2 flex items-center justify-between">
                              <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300 product-category">{{ product.category.name }}</span>
                              <a href="{% url 'product_detail' product.id %}" class="px-3 py-2 rounded-md bg-sky-500 text-white text-xs font-medium hover:bg-sky-600 transition">View Details</a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </article>
                    {% empty %}
                    <div class="flex-shrink-0 w-full text-center py-8">
                      <p class="text-slate-400 text-sm italic">No approved ads in this category.</p>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                
                <!-- Scroll indicators (hidden on mobile) -->
                <div class="hidden md:flex absolute top-0 bottom-0 left-0 w-8 items-center justify-center bg-gradient-to-r from-slate-900 to-transparent pointer-events-none">
                  <span class="text-slate-400 text-xl">‹</span>
                </div>
                <div class="hidden md:flex absolute top-0 bottom-0 right-0 w-8 items-center justify-center bg-gradient-to-l from-slate-900 to-transparent pointer-events-none">
                  <span class="text-slate-400 text-xl">›</span>
                </div>
              </div>
            </div>
            {% endif %}
          {% endfor %}
        </div>
      </section>
    </main>
  </div>

  <!-- mobile slide-over -->
  <div id="mobileSidebar" class="fixed inset-0 z-50 hidden md:hidden">
    <div id="mobileOverlay" class="absolute inset-0 bg-black/50"></div>
    <aside class="absolute left-0 top-0 bottom-0 w-64 bg-[color:var(--sidebar-bg)] p-4">
      <div class="flex items-center gap-3 mb-4">
        {% if user.is_authenticated %}
          <div class="rounded-full bg-slate-700 w-10 h-10 flex items-center justify-center">
            {{ user.full_name|first|default:user.username|first|upper }}
          </div>
          <div>
            <div class="text-sm font-semibold">{{ user.full_name|default:user.username }}</div>
            <div class="text-xs text-[color:var(--muted)]">Welcome!</div>
          </div>
        {% else %}
          <div class="rounded-full bg-slate-700 w-10 h-10 flex items-center justify-center">DH</div>
          <div>
            <div class="text-sm font-semibold">Guest</div>
            <div class="text-xs text-[color:var(--muted)]">Please log in</div>
          </div>
        {% endif %}
      </div>
      
    
    
      
      <nav class="space-y-2">
        <a href="{% url 'about_us' %}" class="block px-3 py-2 rounded text-[color:var(--muted)] hover:bg-white/3">About Us</a>
        {% if user.is_authenticated %}
          <a href="{% url 'dashboard' %}" class="block px-3 py-2 rounded text-[color:var(--muted)] hover:bg-white/3">Profile</a>
          <a href="{% url 'notification_center' %}" class="block px-3 py-2 rounded text-[color:var(--muted)] hover:bg-white/3">Notifications
            {% if unread_count > 0 %}
              <span class="ml-2 inline-flex items-center justify-center h-4 w-4 rounded-full bg-red-500 text-[9px] text-white">
                {{ unread_count }}
              </span>
            {% endif %}
          </a>
          <a href="{% url 'my_favorites' %}" class="block px-3 py-2 rounded text-[color:var(--muted)] hover:bg-white/3">Favorites
            {% if favorites_count > 0 %}
              <span class="ml-2 inline-flex items-center justify-center h-4 w-4 rounded-full bg-red-500 text-[9px] text-white">
                {{ favorites_count }}
              </span>
            {% endif %}
          </a>
          <form method="post" action="{% url 'logout' %}" class="block">{% csrf_token %}
            <button type="submit" class="w-full text-left px-3 py-2 rounded text-[color:var(--muted)] hover:bg-white/3">Logout</button>
          </form>
        {% else %}
          <a href="{% url 'login' %}" class="block px-3 py-2 rounded text-[color:var(--muted)] hover:bg-white/3">Login</a>
        {% endif %}
      </nav>
    </aside>
  </div>

  <style>
    /* Prevent overflow on root - kept safe for desktop and mobile */
    html, body { overflow-x: hidden; }

    /* Ensure main can shrink inside flex layout (prevents flex overflow) */
    .site-main { min-width: 0; }

    .category-scroll-container {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      cursor: grab;
      position: relative;
      z-index: 1;
      min-height: 300px;
      touch-action: pan-y;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .category-scroll-container:active {
      cursor: grabbing;
    }
    
    .category-scroll-container .flex {
      position: relative;
      z-index: 2;
    }
    
    .category-scroll-container::-webkit-scrollbar {
      height: 6px;
    }
    
    .category-scroll-container::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 3px;
    }
    
    .category-scroll-container::-webkit-scrollbar-thumb {
      background: rgba(100, 116, 139, 0.7);
      border-radius: 3px;
    }
    
    .category-scroll-container::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.9);
    }
    
    .category-scroll-container {
      scrollbar-width: thin;
      scrollbar-color: rgba(100, 116, 139, 0.7) rgba(30, 41, 59, 0.5);
    }
    
    .category-scroll-container.dragging {
      scroll-behavior: auto;
      user-select: none;
      cursor: grabbing;
    }
    
    .category-scroll-container.dragging * {
      pointer-events: none;
    }
    
    .category-scroll-container.dragging a {
      pointer-events: none;
    }

    .category-scroll-container img {
      -webkit-user-drag: none;
      -user-drag: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>

<script>
    // Simple and effective filter function
    function filterProducts(keyword) {
      const searchTerm = keyword.toLowerCase().trim();
      let visibleCount = 0;
      
      // Loop through all product cards
      document.querySelectorAll('.asset-card').forEach(card => {
        const productName = card.querySelector('.product-name').textContent.toLowerCase();
        const productCategory = card.querySelector('.product-category').textContent.toLowerCase();
        const productLocation = card.getAttribute('data-location');
        
        const matches = productName.includes(searchTerm) || 
                       productCategory.includes(searchTerm) || 
                       productLocation.includes(searchTerm);
        
        if (searchTerm === '' || matches) {
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });
      
      // Update the asset count
      document.getElementById('assetCount').textContent = visibleCount;
      
      // Hide empty category sections
      document.querySelectorAll('.category-section').forEach(section => {
        const hasVisibleProducts = section.querySelector('.asset-card[style="display: block"]') || 
                                  section.querySelector('.asset-card:not([style*="display: none"])');
        
        if (!hasVisibleProducts && searchTerm !== '') {
          section.style.display = 'none';
        } else {
          section.style.display = 'block';
        }
      });
    }

    // Initialize filter functionality
    document.addEventListener('DOMContentLoaded', function() {
      const filterInput = document.getElementById('filterInput');
      const sortButton = document.getElementById('sortButton');
      const refreshButton = document.getElementById('refresh');
      
      // Filter on input
      if (filterInput) {
        filterInput.addEventListener('input', function(e) {
          filterProducts(e.target.value);
        });
      }
      
      // Sort functionality
      if (sortButton) {
        let sortAscending = false;
        
        sortButton.addEventListener('click', function() {
          sortAscending = !sortAscending;
          sortButton.textContent = `Display name ${sortAscending ? '▴' : '▾'}`;
          
          document.querySelectorAll('.category-scroll-container').forEach(container => {
            const flexContainer = container.querySelector('.flex');
            const cards = Array.from(flexContainer.querySelectorAll('.asset-card'));
            
            cards.sort((a, b) => {
              const nameA = a.querySelector('.product-name').textContent.toLowerCase();
              const nameB = b.querySelector('.product-name').textContent.toLowerCase();
              
              if (sortAscending) {
                return nameA.localeCompare(nameB);
              } else {
                return nameB.localeCompare(nameA);
              }
            });
            
            // Reappend sorted cards
            cards.forEach(card => flexContainer.appendChild(card));
          });
        });
      }
      
      // Refresh button effect
      if (refreshButton) {
        refreshButton.addEventListener('click', function() {
          this.classList.add('opacity-50');
          setTimeout(() => {
            this.classList.remove('opacity-50');
            // Optional: Add actual refresh logic here
            // window.location.reload();
          }, 400);
        });
      }
      
      // Mobile sidebar functionality
      const mobileToggle = document.getElementById('mobileToggle');
      const mobileSidebar = document.getElementById('mobileSidebar');
      const mobileOverlay = document.getElementById('mobileOverlay');
      
      if (mobileToggle && mobileSidebar) {
        mobileToggle.addEventListener('click', function() {
          mobileSidebar.classList.toggle('hidden');
        });
        
        if (mobileOverlay) {
          mobileOverlay.addEventListener('click', function() {
            mobileSidebar.classList.add('hidden');
          });
        }
      }
      
      // Improved Horizontal scroll with drag functionality
      function initializeHorizontalScroll() {
        const containers = document.querySelectorAll('.category-scroll-container');
        
        containers.forEach(container => {
          let isDown = false;
          let isDragging = false;
          let startX;
          let scrollLeft;
          let clickStartX;
          let clickStartY;
          let clickStartTime;
          
          container.addEventListener('mousedown', (e) => {
            // Store initial click position and time
            clickStartX = e.pageX;
            clickStartY = e.pageY;
            clickStartTime = Date.now();
            
            isDown = true;
            startX = e.pageX - container.offsetLeft;
            scrollLeft = container.scrollLeft;
          });
          
          container.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            
            const x = e.pageX - container.offsetLeft;
            const walk = (x - startX) * 2;
            
            // Check if this is actually a drag (movement threshold)
            const moveX = Math.abs(e.pageX - clickStartX);
            const moveY = Math.abs(e.pageY - clickStartY);
            
            if (moveX > 5 || moveY > 5) {
              isDragging = true;
              container.classList.add('dragging');
              e.preventDefault();
              container.scrollLeft = scrollLeft - walk;
            }
          });
          
          container.addEventListener('mouseup', (e) => {
            if (!isDown) return;
            
            const clickDuration = Date.now() - clickStartTime;
            const moveX = Math.abs(e.pageX - clickStartX);
            const moveY = Math.abs(e.pageY - clickStartY);
            
            // If it was a quick click with minimal movement, treat as click
            if (clickDuration < 300 && moveX < 5 && moveY < 5 && !isDragging) {
              // Find if we clicked on a link
              const element = document.elementFromPoint(e.clientX, e.clientY);
              const link = element.closest('a');
              
              if (link) {
                e.preventDefault();
                window.location.href = link.href;
              }
            }
            
            isDown = false;
            isDragging = false;
            container.classList.remove('dragging');
          });
          
          container.addEventListener('mouseleave', () => {
            isDown = false;
            isDragging = false;
            container.classList.remove('dragging');
          });
          
          // Touch events for mobile
          container.addEventListener('touchstart', (e) => {
            isDown = true;
            startX = e.touches[0].pageX - container.offsetLeft;
            scrollLeft = container.scrollLeft;
            clickStartTime = Date.now();
            clickStartX = e.touches[0].pageX;
            clickStartY = e.touches[0].pageY;
          });
          
          container.addEventListener('touchmove', (e) => {
            if (!isDown) return;
            
            const x = e.touches[0].pageX - container.offsetLeft;
            const walk = (x - startX) * 2;
            
            const moveX = Math.abs(e.touches[0].pageX - clickStartX);
            const moveY = Math.abs(e.touches[0].pageY - clickStartY);
            
            if (moveX > 5 || moveY > 5) {
              isDragging = true;
              container.classList.add('dragging');
              e.preventDefault();
              container.scrollLeft = scrollLeft - walk;
            }
          });
          
          container.addEventListener('touchend', (e) => {
            if (!isDown) return;
            
            const clickDuration = Date.now() - clickStartTime;
            const moveX = Math.abs(e.changedTouches[0].pageX - clickStartX);
            const moveY = Math.abs(e.changedTouches[0].pageY - clickStartY);
            
            // If it was a quick tap with minimal movement, treat as click
            if (clickDuration < 300 && moveX < 10 && moveY < 10 && !isDragging) {
              const element = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
              const link = element ? element.closest('a') : null;
              
              if (link) {
                e.preventDefault();
                window.location.href = link.href;
              }
            }
            
            isDown = false;
            isDragging = false;
            container.classList.remove('dragging');
          });
        });
      }
      
      initializeHorizontalScroll();
    });

    // Close mobile sidebar when clicking outside
    document.addEventListener('click', function(e) {
      const mobileSidebar = document.getElementById('mobileSidebar');
      const mobileToggle = document.getElementById('mobileToggle');
      
      if (mobileSidebar && !mobileSidebar.classList.contains('hidden') && 
          !mobileSidebar.contains(e.target) && 
          e.target !== mobileToggle && 
          !mobileToggle.contains(e.target)) {
        mobileSidebar.classList.add('hidden');
      }
    });

    // Add direct click handlers for product images as backup
    document.addEventListener('click', function(e) {
      // If clicking on a product image that's inside a scroll container
      const productImage = e.target.closest('.product-image');
      if (productImage) {
        const link = productImage.closest('a');
        if (link && link.href) {
          e.preventDefault();
          window.location.href = link.href;
        }
      }
    });
  </script>
</body>
{% endblock %}
