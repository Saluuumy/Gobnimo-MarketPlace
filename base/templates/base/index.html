{% extends 'main.html' %}
{% load static %}

{% block content %}
<div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-40"></div>

<!-- Refactored Index Template: Sponsored / Featured carousel + Category scrollers -->
<style>
  /* Theme helpers */
  :root{
    --gap: 1rem;
    --card-w-desktop: 16rem; /* 256px */
  }

  /* Accessible focus ring */
  :focus-visible {
    outline: none;
    box-shadow: 0 0 0 4px rgba(124,58,237,0.16);
    border-radius: .5rem;
  }

  /* Carousel / Track styles */
  .carousel-wrapper { 
    overflow: hidden; 
    position: relative; 
  }
  
  .carousel-track { 
    display: flex; 
    gap: var(--gap); 
    align-items: stretch; 
  }
  
  .carousel-group { 
    display: flex; 
    gap: var(--gap); 
    flex-shrink: 0;
  }

  /* Infinite scrolling animation */
  @keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(calc(-100% - var(--gap))); }
  }
  
  .carousel-track.animate {
    animation: scroll 30s linear infinite;
  }
  
  .carousel-wrapper:hover .carousel-track {
    animation-play-state: paused;
  }

  /* Desktop product card sizing */
  .desktop-card { flex: 0 0 var(--card-w-desktop); }

  /* Mobile horizontal lists: touch-friendly */
  .product-container {
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }
  .product-container > .product-card {
    scroll-snap-align: start;
  }

  /* Reduced motion respect */
  @media (prefers-reduced-motion: reduce) {
    .carousel-track { animation: none !important; }
  }

  /* Small utility tweaks */
  .badge-pill { padding: .125rem .5rem; font-size: .7rem; border-radius: .375rem; }
  .card-image { height: 9rem; object-fit: cover; width: 100%; }
</style>

<section class="bg-purple-50 py-6">
  <div class="max-w-6xl mx-auto px-4">
    <div class="bg-gradient-to-r from-purple-600/90 to-pink-500/90 rounded-3xl shadow-lg p-6 md:p-8 relative z-10">

      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center">
          <span class="premium-badge bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded-full w-9 h-9 flex items-center justify-center mr-3 shadow" aria-hidden="true">
            <i class="fas fa-crown text-sm" style="position: relative;
  top: 10px;"></i>
          </span>
          <h2 class="font-bold text-white text-lg md:text-xl">Sponsored Products</h2>
        </div>

        <div>
          <a href="{% url 'menu' %}?is_paid=true"
             class="advertise-btn inline-flex items-center gap-2 ml-2 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-gray-900 px-4 py-2 rounded-lg text-xs sm:text-sm font-semibold shadow transition-all duration-300"
             role="button" aria-label="Advertise here">
            <i class="fas fa-bullhorn"></i>
            <span>Advertise Here</span>
          </a>
        </div>
      </div>

      <!-- Desktop Carousel -->
      <div class="hidden md:block">
        <div class="carousel-wrapper">
          <div class="carousel-track carousel-group animate" aria-hidden="false">
            {% comment %} Single group of featured cards {% endcomment %}
            {% for product in featured_products|slice:":8" %}
              <article class="relative bg-white rounded-xl shadow-md overflow-hidden border border-purple-200 flex-shrink-0 desktop-card product-card" role="article" aria-label="{{ product.name }}">
                <div class="absolute top-3 left-3 badge-pill bg-gradient-to-r from-purple-600 to-pink-500 text-white font-semibold drop-shadow">FEATURED</div>
                <a href="{% url 'product_detail' product.id %}" aria-label="Open {{ product.name }}">
                  {% if product.images.first %}
                    <img src="{{ product.images.first.image.url }}" srcset="{{ product.images.first.image.url }} 1x, {{ product.images.first.image.url }} 2x" loading="lazy" alt="{{ product.name }} - {{ product.location }} - ${{ product.price }}" class="card-image">
                  {% else %}
                    <div class="bg-gray-100 w-full h-36 flex items-center justify-center border-dashed border-2 border-gray-200">
                      <i class="fas fa-image text-gray-400 text-3xl" aria-hidden="true"></i>
                    </div>
                  {% endif %}
                </a>
                <div class="p-3">
                  <h3 class="font-semibold text-sm truncate">{{ product.name|truncatechars:40 }}</h3>
                  <p class="text-xs text-gray-500 mt-1">{{ product.location|default:"" }} &middot; {{ product.created_at|timesince }} ago</p>
                  <div class="mt-2 flex items-center justify-between">
                    <div class="text-base font-bold text-purple-700">${{ product.price }}</div>
                    <a href="{% url 'product_detail' product.id %}" class="inline-block px-2.5 py-1.5 rounded-md bg-gradient-to-r from-purple-600 to-pink-500 text-white text-xs font-medium">View</a>
                  </div>
                </div>
              </article>
            {% endfor %}
            
            {% comment %} Duplicate for seamless looping {% endcomment %}
            {% for product in featured_products|slice:":8" %}
              <article class="relative bg-white rounded-xl shadow-md overflow-hidden border border-purple-200 flex-shrink-0 desktop-card product-card" role="article" aria-label="{{ product.name }} (duplicate)">
                <div class="absolute top-3 left-3 badge-pill bg-gradient-to-r from-purple-600 to-pink-500 text-white font-semibold drop-shadow">FEATURED</div>
                <a href="{% url 'product_detail' product.id %}" aria-label="Open {{ product.name }}">
                  {% if product.images.first %}
                    <img src="{{ product.images.first.image.url }}" srcset="{{ product.images.first.image.url }} 1x, {{ product.images.first.image.url }} 2x" loading="lazy" alt="{{ product.name }} - {{ product.location }} - ${{ product.price }}" class="card-image">
                  {% else %}
                    <div class="bg-gray-100 w-full h-36 flex items-center justify-center border-dashed border-2 border-gray-200">
                      <i class="fas fa-image text-gray-400 text-3xl" aria-hidden="true"></i>
                    </div>
                  {% endif %}
                </a>
                <div class="p-3">
                  <h3 class="font-semibold text-sm truncate">{{ product.name|truncatechars:40 }}</h3>
                  <p class="text-xs text-gray-500 mt-1">{{ product.location|default:"" }} &middot; {{ product.created_at|timesince }} ago</p>
                  <div class="mt-2 flex items-center justify-between">
                    <div class="text-base font-bold text-purple-700">${{ product.price }}</div>
                    <a href="{% url 'product_detail' product.id %}" class="inline-block px-2.5 py-1.5 rounded-md bg-gradient-to-r from-purple-600 to-pink-500 text-white text-xs font-medium">View</a>
                  </div>
                </div>
              </article>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Mobile: horizontal scroll with scroll-snap -->
      <div class="ad-container flex overflow-x-auto pb-4 -mx-2 px-2 md:hidden product-container" aria-label="Sponsored products">
        {% for product in featured_products|slice:":8" %}
          <div class="flex-shrink-0 w-52 bg-white rounded-xl shadow-md border border-purple-200 mx-2 overflow-hidden hover:shadow-lg transition product-card" role="article" aria-label="{{ product.name }}">
            <div class="relative">
              <a href="{% url 'product_detail' product.id %}" aria-label="Open {{ product.name }}">
                {% if product.images.first %}
                  <img src="{{ product.images.first.image.url }}" srcset="{{ product.images.first.image.url }} 1x, {{ product.images.first.image.url }} 2x" loading="lazy" alt="{{ product.name }}" class="w-full h-32 object-cover">
                {% else %}
                  <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-32 flex items-center justify-center">
                    <i class="fas fa-image text-gray-400 text-3xl" aria-hidden="true"></i>
                  </div>
                {% endif %}
                <span class="absolute top-2 right-2 bg-gradient-to-r from-purple-600 to-pink-500 text-white text-[10px] px-2 py-0.5 rounded">Sponsored</span>
              </a>
            </div>
            <div class="p-3">
              <h3 class="font-semibold text-sm truncate text-purple-800">{{ product.name }}</h3>
              <div class="flex items-center mt-2 text-xs">
                <span class="font-bold text-pink-500">${{ product.price }}</span>
                <span class="ml-auto text-gray-500">
                  <i class="fas fa-eye mr-1" aria-hidden="true"></i>{{ product.views }}
                </span>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    </div>
  </div>
</section>

<section class="categories-section py-6 -mt-4 px-4 bg-gradient-to-b from-purple-50 to-white relative z-0">
  <div class="container mx-auto max-w-6xl">
    <div class="text-center mb-5">
      <h2 class="text-xl font-bold text-gray-900 mb-1">Browse by Category</h2>
      <p class="text-gray-600 text-sm max-w-2xl mx-auto">Explore products in our categories</p>
    </div>

    {% for category in categories %}
      {% if category.approved_ads %}
      <div class="mb-5">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-lg font-bold text-gray-900">{{ category.name }}</h3>
          <div class="flex space-x-1">
            <button class="scroll-btn prev-btn p-1.5 rounded-full shadow-sm bg-white text-purple-800 hover:bg-purple-100 border border-gray-200" data-category="{{ category.id }}" aria-label="Previous {{ category.name }}">
              <i class="fas fa-chevron-left text-xs" aria-hidden="true"></i>
            </button>
            <button class="scroll-btn next-btn p-1.5 rounded-full shadow-sm bg-white text-purple-800 hover:bg-purple-100 border border-gray-200" data-category="{{ category.id }}" aria-label="Next {{ category.name }}">
              <i class="fas fa-chevron-right text-xs" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <div class="relative -mt-1">
          <div class="product-container flex overflow-x-auto pb-3 space-x-3" data-category="{{ category.id }}" aria-label="{{ category.name }} products">
            {% for product in category.approved_ads %}
            <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200 hover:shadow-md transition flex-shrink-0 w-56 product-card" role="article" aria-label="{{ product.name }}">
              <div class="relative">
                {% if product.images.first %}
                <a href="{% url 'product_detail' product.id %}">
                  <img src="{{ product.images.first.image.url }}" srcset="{{ product.images.first.image.url }} 1x, {{ product.images.first.image.url }} 2x" loading="lazy" alt="{{ product.name }}" class="w-full h-40 object-cover">
                </a>
                {% else %}
                <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-40 flex items-center justify-center">
                  <i class="fas fa-image text-gray-400 text-3xl" aria-hidden="true"></i>
                </div>
                {% endif %}

                {% if product.is_featured %}
                <span class="absolute top-1 left-1 bg-pink-500 text-white text-xs font-bold px-1.5 py-0.5 rounded">Featured</span>
                {% endif %}

                <span class="absolute top-1 right-1 bg-black bg-opacity-70 text-white text-xs font-bold px-1.5 py-0.5 rounded">${{ product.price }}</span>
              </div>

              <div class="p-3">
                <h3 class="font-bold text-sm mb-1 truncate">{{ product.name }}</h3>
                <div class="flex items-center text-gray-600 text-xs mb-1">
                  <i class="fas fa-map-marker-alt mr-1 text-xs" aria-hidden="true"></i>
                  <span class="truncate">{{ product.location }}</span>
                </div>
                <div class="flex items-center text-gray-600 text-xs">
                  <i class="far fa-clock mr-1 text-xs" aria-hidden="true"></i>
                  <span>{{ product.created_at|timesince }} ago</span>
                </div>
                <div class="flex justify-between items-center mt-2">
                  <span class="text-xs bg-gray-100 px-1.5 py-0.5 rounded">{{ product.category.name }}</span>
                  <a href="{% url 'product_detail' product.id %}" class="text-pink-600 hover:text-pink-800 font-medium text-xs">View Details</a>
                </div>
              </div>
            </div>
            {% empty %}
            <p class="text-gray-600 text-xs italic py-2">No approved ads in this category.</p>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}

  </div>
</section>

{% include 'footer.html' %}

<script>
// ------------------------
// Robust client JS for index page
// - Guards against missing selectors
// - Smooth, pausable auto-scroll for sponsor strip
// - Scroll buttons for category scrollers
// - Respects reduced-motion
// ------------------------

document.addEventListener('DOMContentLoaded', () => {
  const q = (sel, ctx = document) => ctx.querySelector(sel);
  const qa = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

  // --- Auto-scroll for mobile sponsor strip ---
  const adContainer = q('.ad-container');
  if (adContainer) {
    let running = false;
    let rafId = null;
    const speed = 0.35; // px per frame
    let pos = adContainer.scrollLeft;

    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (!prefersReduced && adContainer.scrollWidth > adContainer.clientWidth) {
      function step() {
        const max = adContainer.scrollWidth - adContainer.clientWidth;
        pos = pos + speed;
        if (pos >= max) pos = 0;
        adContainer.scrollLeft = pos;
        rafId = requestAnimationFrame(step);
      }
      function start() {
        if (running) return;
        running = true;
        rafId = requestAnimationFrame(step);
      }
      function stop() {
        running = false;
        if (rafId) cancelAnimationFrame(rafId);
      }

      // start
      start();
      ['mouseenter', 'focusin', 'touchstart'].forEach(e => adContainer.addEventListener(e, stop, { passive: true }));
      ['mouseleave', 'focusout', 'touchend'].forEach(e => adContainer.addEventListener(e, start, { passive: true }));
    }
  }

  // --- Scroll buttons for category lists ---
  qa('.scroll-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const catId = btn.getAttribute('data-category');
      if (!catId) return;
      const container = document.querySelector(`.product-container[data-category="${catId}"]`);
      if (!container) return;
      const isPrev = btn.classList.contains('prev-btn');
      const card = container.querySelector('.product-card');
      const cardRect = card ? card.getBoundingClientRect() : null;
      const scrollAmount = cardRect ? Math.round(cardRect.width + 12) : 288;
      container.scrollBy({ left: isPrev ? -scrollAmount : scrollAmount, behavior: 'smooth' });
    });
  });

  // --- Advertise CTA fallback ---
  const advertiseBtn = q('.advertise-btn');
  if (advertiseBtn) {
    advertiseBtn.addEventListener('click', (e) => {
      // Let the link navigate normally. Optional: open a lightweight modal instead.
      // Example: if you want modal behavior, preventDefault() and show modal.
    });
  }

  // --- Keyboard accessibility for horizontal scrollers (left/right) ---
  qa('.product-container').forEach(container => {
    container.setAttribute('tabindex', '0');
    container.addEventListener('keydown', (ev) => {
      if (ev.key === 'ArrowRight') {
        container.scrollBy({ left: 280, behavior: 'smooth' });
        ev.preventDefault();
      } else if (ev.key === 'ArrowLeft') {
        container.scrollBy({ left: -280, behavior: 'smooth' });
        ev.preventDefault();
      }
    });
  });
});
</script>

{% endblock %}