{% extends 'main.html' %}
{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ ad.name }} | SomaliShoppe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --sidebar-bg:#0f1720;
      --panel:#0b1220;
      --muted:#9ca3af;
      --chip:#1f2937;
      --accent:#06b6d4;
      --tile-bg:#2b3440;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--panel);
      color: #e6eef8;
      -webkit-font-smoothing: antialiased;
    }
    
    .card {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border-radius: 12px;
      background: var(--tile-bg);
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .gallery-main {
      height: 300px;
      object-fit: cover;
      border-radius: 10px;
    }
    
    .gallery-thumb {
      transition: all 0.2s ease;
      cursor: pointer;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid transparent;
    }
    
    .gallery-thumb:hover, .gallery-thumb.active {
      transform: translateY(-2px);
      border-color: var(--accent);
    }
    
    .attribute-item {
      transition: all 0.2s ease;
      border-radius: 10px;
    }
    
    .attribute-item:hover {
      background-color: rgba(255,255,255,0.05);
      transform: translateY(-1px);
    }
    
    .discount-badge {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    
    .compact-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
    
    .attribute-value {
      font-weight: 500;
      color: #e6eef8;
      font-size: 0.9rem;
    }
    
    .attribute-label {
      color: var(--muted);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    
    .attribute-icon {
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 2px;
    }
    
    .property-feature {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .property-feature i {
      margin-right: 8px;
      width: 18px;
      text-align: center;
      color: var(--accent);
      font-size: 0.85rem;
    }
    
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .comment-card {
      transition: all 0.2s ease;
      background: var(--tile-bg);
    }
    
    .comment-card:hover {
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.1);
    }
    
    .reply-form {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .reply-form.active {
      max-height: 150px;
    }
    
    .gradient-btn {
      background: linear-gradient(to right, var(--accent), #0d9488);
      transition: all 0.3s ease;
    }
    
    .gradient-btn:hover {
      background: linear-gradient(to right, #0d9488, #0f766e);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(6, 182, 212, 0.3);
    }
    
    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .comment-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .delete-btn {
      color: #ef4444;
      transition: all 0.2s;
    }
    
    .delete-btn:hover {
      color: #dc2626;
      transform: scale(1.1);
    }
    
    .accent-color {
      color: var(--accent);
    }
    
    .accent-bg {
      background-color: rgba(6, 182, 212, 0.1);
    }
    
    .accent-border {
      border-color: rgba(6, 182, 212, 0.3);
    }
    
    /* Share section styles */
    .share-section {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .share-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .share-buttons {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .share-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .facebook-btn {
      background-color: #3b5998;
      color: white;
    }
    
    .whatsapp-btn {
      background-color: #25d366;
      color: white;
    }
    
    .twitter-btn {
      background-color: #1da1f2;
      color: white;
    }
    
    .email-btn {
      background-color: #ea4335;
      color: white;
    }
    
    .copy-btn {
      background-color: var(--accent);
      color: white;
    }
    
    .share-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .share-modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .share-modal-content {
      background-color: var(--tile-bg);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 90%;
      width: 400px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      transform: translateY(20px);
      transition: transform 0.3s ease;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .share-modal.active .share-modal-content {
      transform: translateY(0);
    }
    
    .share-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .share-modal-title {
      font-weight: 600;
      font-size: 1.2rem;
      color: #e6eef8;
    }
    
    .share-modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted);
    }
    
    .share-input-group {
      display: flex;
      margin-bottom: 1.5rem;
    }
    
    .share-input {
      flex-grow: 1;
      padding: 0.75rem;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px 0 0 8px;
      font-size: 0.9rem;
      background: var(--chip);
      color: #e6eef8;
    }
    
    .copy-button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0 1rem;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .copy-button:hover {
      background: #0891b2;
    }
    
    .share-success {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      padding: 0.75rem;
      border-radius: 8px;
      text-align: center;
      display: none;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .share-success.active {
      display: block;
    }
    
    /* Mobile layout adjustments */
    @media (max-width: 768px) {
      .gallery-main {
        height: 250px;
      }
      
      .compact-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      
      .feature-grid {
        grid-template-columns: 1fr;
      }
      
      .attribute-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .comment-header {
        flex-direction: column;
        gap: 8px;
      }
      
      .mobile-order-1 {
        order: 1;
      }
      
      .mobile-order-2 {
        order: 2;
      }
      
      .mobile-order-3 {
        order: 3;
      }
      
      .share-buttons {
        justify-content: center;
      }
    }
    
    @media (max-width: 480px) {
      .gallery-main {
        height: 200px;
      }
      .max-w-\[90\%\] {
        max-width: 35%;
      }
      
      .compact-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      }
      
      .attribute-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .attribute-icon {
        font-size: 1rem;
      }
      
      .attribute-value {
        font-size: 0.85rem;
      }
    }
    
    /* Reduced spacing between sections */
    .compact-section {
      margin-bottom: 0.75rem !important;
    }
    
    .compact-card {
      padding: 1.25rem !important;
    }
    
    /* Tighter attribute grid */
    .attribute-grid {
      gap: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    @media (min-width: 1024px) {
      .bg-white.rounded-xl.card.compact {
        position: relative;
        top: -190px;
      }
    }
    
    /* Additional dark theme adjustments */
    .bg-gray-50 {
      background: var(--panel) !important;
    }
    
    .text-gray-800, .text-gray-900 {
      color: #e6eef8 !important;
    }
    
    .text-gray-600, .text-gray-700 {
      color: var(--muted) !important;
    }
    
    .bg-white {
      background: var(--tile-bg) !important;
    }
    
    .border-gray-200 {
      border-color: rgba(255,255,255,0.05) !important;
    }
    
    .bg-gray-100 {
      background: var(--chip) !important;
    }
    
    .bg-purple-50 {
      background: rgba(6, 182, 212, 0.05) !important;
    }
    
    .border-purple-200, .border-purple-300 {
      border-color: rgba(6, 182, 212, 0.3) !important;
    }
    
    .bg-purple-600 {
      background: var(--accent) !important;
    }
    
    .from-purple-600 {
      --tw-gradient-from: var(--accent) !important;
    }
    
    .to-indigo-600 {
      --tw-gradient-to: #0d9488 !important;
    }
    
    .hover\:from-purple-700:hover {
      --tw-gradient-from: #0891b2 !important;
    }
    
    .hover\:to-indigo-700:hover {
      --tw-gradient-to: #0f766e !important;
    }
    
    .bg-gradient-to-b {
      background-image: linear-gradient(to bottom, rgba(6, 182, 212, 0.05), transparent) !important;
    }
    
    .bg-gray-300 {
      background: var(--chip) !important;
      color: var(--muted) !important;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <main class="container mx-auto px-4 py-5 flex-grow">
    <!-- Fixed grid structure with proper mobile ordering -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <!-- Gallery Section -->
      <div class="lg:col-span-7 mobile-order-1 compact-section">
        <div class="rounded-xl card p-3">
          {% if ad.images.all %}
            <img id="mainImage" src="{{ ad.images.first.image.url }}" 
                 alt="{{ ad.name }}" class="gallery-main w-full">
          {% else %}
            <div class="gallery-main w-full bg-gray-100 rounded-xl flex items-center justify-center">
              <i class="fas fa-image text-gray-300 text-5xl"></i>
            </div>
          {% endif %}
          
          <div class="grid compact-grid gap-2 mt-3">
            {% for image in ad.images.all %}
              <div class="gallery-thumb {% if forloop.first %}active{% endif %}" 
                   onclick="changeMainImage('{{ image.image.url }}', this)">
                <img src="{{ image.image.url }}" alt="Thumbnail {{ forloop.counter }}" 
                     class="w-full h-20 object-cover">
              </div>
            {% empty %}
              {% for i in "1234" %}
                <div class="gallery-thumb bg-gray-100 border border-gray-200 rounded-lg flex items-center justify-center">
                  <i class="fas fa-image text-gray-300 text-xl"></i>
                </div>
              {% endfor %}
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Details Section -->
      <div class="lg:col-span-5 mobile-order-2">
        <div class="rounded-xl card compact-card">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h1 class="text-2xl font-bold mb-1">{{ ad.name }}</h1>
              <div class="flex items-center text-sm mb-2">
                <div class="flex items-center mr-3">
                  <i class="fas fa-eye mr-1"></i> {{ ad.views|default:0 }} views
                </div>
                <div class="flex items-center">
                  <i class="fas fa-map-marker-alt accent-color mr-1"></i> 
                  <span>{{ ad.location }}</span>
                  <span class="mx-2 opacity-50">•</span>
                  <span class="font-medium">{{ ad.get_ad_type_display }}</span>
                </div>
              </div>
            </div>
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'toggle_favorite' ad.id %}" class="favorite-form">
              {% csrf_token %}
              <button type="submit" class="text-gray-400 hover:text-red-500 transition">
                <i class="{% if ad.id in user_favorites %}fas{% else %}far{% endif %} fa-bookmark text-lg"></i>
              </button>
            </form>
            {% else %}
            <a href="{% url 'login' %}" class="text-gray-400 hover:text-red-500 transition">
              <i class="far fa-bookmark text-lg"></i>
            </a>
            {% endif %}
          </div>

          <!-- Price -->
          <div class="flex items-center mb-4">
            <span class="text-2xl font-bold mr-2">${{ ad.price }}</span>
            {% if ad.ad_type == 'rent' %}
            <span class="text-sm">per month</span>
            {% endif %}
          </div>
          
          <!-- Attributes Grid -->
          <div class="grid grid-cols-4 gap-3 mb-4 pb-4 attribute-grid">
            <div class="flex flex-col items-center text-center">
              <i class="fas fa-tag attribute-icon"></i>
              <div class="attribute-label">Category</div>
              <div class="attribute-value">{{ ad.category.name }}</div>
            </div>
            
            {% if ad.property_type %}
              {% if ad.num_rooms %}
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-bed attribute-icon"></i>
                <div class="attribute-label">Rooms</div>
                <div class="attribute-value">{{ ad.num_rooms }}</div>
              </div>
              {% endif %}
              
              {% if ad.num_baths %}
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-bath attribute-icon"></i>
                <div class="attribute-label">Baths</div>
                <div class="attribute-value">{{ ad.num_baths }}</div>
              </div>
              {% endif %}
              
              {% if ad.area_size %}
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-ruler-combined attribute-icon"></i>
                <div class="attribute-label">Area</div>
                <div class="attribute-value">{{ ad.area_size }} m²</div>
              </div>
              {% endif %}
            {% elif ad.vehicle_type %}
              {% if ad.year %}
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-calendar attribute-icon"></i>
                <div class="attribute-label">Year</div>
                <div class="attribute-value">{{ ad.year }}</div>
              </div>
              {% endif %}
              
              {% if ad.motortype %}
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-cogs attribute-icon"></i>
                <div class="attribute-label">Engine</div>
                <div class="attribute-value">{{ ad.motortype }}</div>
              </div>
              {% endif %}
              
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-cog attribute-icon"></i>
                <div class="attribute-label">Transmission</div>
                <div class="attribute-value">{{ ad.geartype }}</div>
              </div>
                  {% elif ad.land_type %}
              {% if ad.land_area %}
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-ruler-combined attribute-icon"></i>
                <div class="attribute-label">Area</div>
                <div class="attribute-value">{{ ad.land_area }} m²</div>
              </div>
              {% endif %}
              
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-map-marked-alt attribute-icon"></i>
                <div class="attribute-label">Land Type</div>
                <div class="attribute-value">{{ ad.get_land_type_display }}</div>
              </div>
            {% else %}
              {% if ad.year %}
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-calendar attribute-icon"></i>
                <div class="attribute-label">Year</div>
                <div class="attribute-value">{{ ad.year }}</div>
              </div>
              {% endif %}
              
              {% if ad.model %}
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-cube attribute-icon"></i>
                <div class="attribute-label">Model</div>
                <div class="attribute-value">{{ ad.model }}</div>
              </div>
              {% endif %}
              
              {% if ad.color %}
              <div class="flex flex-col items-center text-center">
                <i class="fas fa-palette attribute-icon"></i>
                <div class="attribute-label">Color</div>
                <div class="attribute-value">{{ ad.color }}</div>
              </div>
              {% endif %}
            {% endif %}
          </div>

          {% if ad.vehicle_type %}
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-3">Vehicle Details</h3>
            <div class="feature-grid">
              <div class="property-feature">
                <i class="fas fa-car attribute-icon"></i>
                <div>
                  <div class="attribute-label">Type</div>
                  <div class="attribute-value">{{ ad.get_vehicle_type_display }}</div>
                </div>
              </div>
              
              {% if ad.motortype %}
              <div class="property-feature">
                <i class="fas fa-cogs attribute-icon"></i>
                <div>
                  <div class="attribute-label">Engine</div>
                  <div class="attribute-value">{{ ad.motortype }}</div>
                </div>
              </div>
              {% endif %}
              
              {% if ad.geartype %}
              <div class="property-feature">
                <i class="fas fa-cog attribute-icon"></i>
                <div>
                  <div class="attribute-label">Transmission</div>
                  <div class="attribute-value">{{ ad.geartype }}</div>
                </div>
              </div>
              {% endif %}
              
              <div class="property-feature">
                <i class="fas fa-bolt attribute-icon"></i>
                <div>
                  <div class="attribute-label">Drive Type</div>
                  <div class="attribute-value">{% if ad.is_automatic %}Automatic{% else %}Manual{% endif %}</div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          {% if ad.property_type and ad.furnishing_type %}
          <div class="mb-4">
            <div class="flex items-center bg-gray-100 rounded-lg p-3">
              <i class="fas fa-couch attribute-icon text-xl mr-3"></i>
              <div>
                <div class="attribute-label">Furnishing</div>
                <div class="attribute-value">{{ ad.get_furnishing_type_display }}</div>
              </div>
            </div>
          </div>
          {% endif %}

          {% if ad.property_type %}
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-3">Property Features</h3>
            
            <div class="feature-grid">
              <div class="property-feature">
                <i class="fas fa-car attribute-icon"></i>
                <div>
                  <div class="attribute-label">Parking</div>
                  <div class="attribute-value">
                    {% if ad.has_parking %}Available{% else %}Not Available{% endif %}
                  </div>
                </div>
              </div>
              
              <div class="property-feature">
                <i class="fas fa-swimming-pool attribute-icon"></i>
                <div>
                  <div class="attribute-label">Swimming Pool</div>
                  <div class="attribute-value">
                    {% if ad.has_pool %}Available{% else %}Not Available{% endif %}
                  </div>
                </div>
              </div>
              
              <div class="property-feature">
                <i class="fas fa-faucet attribute-icon"></i>
                <div>
                  <div class="attribute-label">Water Supply</div>
                  <div class="attribute-value">
                    {% if ad.has_water %}Available{% else %}Not Available{% endif %}
                  </div>
                </div>
              </div>
              
              <div class="property-feature">
                <i class="fas fa-bolt attribute-icon"></i>
                <div>
                  <div class="attribute-label">Electricity</div>
                  <div class="attribute-value">
                    {% if ad.has_electricity %}Available{% else %}Not Available{% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Job Details Section -->
          {% if ad.job_type %}
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-3">Job Details</h3>
            <div class="feature-grid">
              <div class="property-feature">
                <i class="fas fa-briefcase attribute-icon"></i>
                <div>
                  <div class="attribute-label">Job Type</div>
                  <div class="attribute-value">{{ ad.get_job_type_display }}</div>
                </div>
              </div>
              
              {% if ad.salary %}
              <div class="property-feature">
                <i class="fas fa-money-bill-wave attribute-icon"></i>
                <div>
                  <div class="attribute-label">Salary</div>
                  <div class="attribute-value">{{ ad.salary }}</div>
                </div>
              </div>
              {% endif %}
              
              {% if ad.experience_required %}
              <div class="property-feature">
                <i class="fas fa-chart-line attribute-icon"></i>
                <div>
                  <div class="attribute-label">Experience</div>
                  <div class="attribute-value">{{ ad.experience_required }}</div>
                </div>
              </div>
              {% endif %}
              
              {% if ad.education_required %}
              <div class="property-feature">
                <i class="fas fa-graduation-cap attribute-icon"></i>
                <div>
                  <div class="attribute-label">Education</div>
                  <div class="attribute-value">{{ ad.education_required }}</div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Service Details Section -->
          {% if ad.service_type %}
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-3">Service Details</h3>
            <div class="feature-grid">
              <div class="property-feature">
                <i class="fas fa-concierge-bell attribute-icon"></i>
                <div>
                  <div class="attribute-label">Service Type</div>
                  <div class="attribute-value">{{ ad.get_service_type_display }}</div>
                </div>
              </div>
              
              {% if ad.service_area %}
              <div class="property-feature">
                <i class="fas fa-map-marked-alt attribute-icon"></i>
                <div>
                  <div class="attribute-label">Service Area</div>
                  <div class="attribute-value">{{ ad.service_area }}</div>
                </div>
              </div>
              {% endif %}
              
              {% if ad.availability %}
              <div class="property-feature">
                <i class="fas fa-calendar-check attribute-icon"></i>
                <div>
                  <div class="attribute-label">Availability</div>
                  <div class="attribute-value">{{ ad.availability }}</div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Fashion Details Section -->
          {% if ad.fashion_type %}
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-3">Fashion Details</h3>
            <div class="feature-grid">
              <div class="property-feature">
                <i class="fas fa-tshirt attribute-icon"></i>
                <div>
                  <div class="attribute-label">Fashion Type</div>
                  <div class="attribute-value">{{ ad.get_fashion_type_display }}</div>
                </div>
              </div>
              
              {% if ad.size %}
              <div class="property-feature">
                <i class="fas fa-ruler attribute-icon"></i>
                <div>
                  <div class="attribute-label">Size</div>
                  <div class="attribute-value">{{ ad.size }}</div>
                </div>
              </div>
              {% endif %}
              
              {% if ad.material %}
              <div class="property-feature">
                <i class="fas fa-cut attribute-icon"></i>
                <div>
                  <div class="attribute-label">Material</div>
                  <div class="attribute-value">{{ ad.material }}</div>
                </div>
              </div>
              {% endif %}
              
              {% if ad.color %}
              <div class="property-feature">
                <i class="fas fa-palette attribute-icon"></i>
                <div>
                  <div class="attribute-label">Color</div>
                  <div class="attribute-value">{{ ad.color }}</div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Description -->
          <div class="mb-4">
            <h3 class="text-lg font-semibold mb-3">Description</h3>
            <p class="">{{ ad.description|default:"This meticulously maintained property combines style, comfort, and reliability in one exceptional package." }}</p>
          </div>

        <!-- Advertiser Card (Enhanced) -->
<div class="rounded-xl shadow-md p-4 flex flex-col sm:flex-row items-center gap-4 border border-gray-200 hover:shadow-lg transition-shadow">
  <!-- Avatar -->
  <img src="{{ ad.advertiser.avatar.url|default:'/static/images/default-avatar.jpg' }}" 
       alt="{{ ad.advertiser.username }}" class="w-16 h-16 rounded-full object-cover border-2 border-accent-border shadow">

  <!-- Info -->
  <div class="flex-grow text-center sm:text-left">
    <h3 class="text-xl font-bold mb-1">{{ ad.advertiser.full_name|default:ad.advertiser.username }}</h3>
    <p class="text-sm">{{ ad.advertiser.bio|default:"No bio available" }}</p>
  </div>

  <!-- Contact Button -->
  {% if ad.advertiser.phone_number %}
  <a href="https://wa.me/{{ ad.advertiser.phone_number }}" 
     class="gradient-btn text-white px-5 py-2 rounded-full font-medium transition flex items-center gap-2">
    <i class="fab fa-whatsapp"></i> Contact Seller
  </a>
  {% else %}
  <button class="bg-gray-300 px-5 py-2 rounded-full font-medium cursor-not-allowed" disabled>
    Contact Seller
  </button>
  {% endif %}
</div>
          
          <!-- Share Section -->
          <div class="share-section">
            <div class="share-title">
              <i class="fas fa-share-alt"></i>
              Share this ad
            </div>
            <div class="share-buttons">
              <div class="share-btn facebook-btn" onclick="shareOnFacebook()">
                <i class="fab fa-facebook-f"></i>
              </div>
              <div class="share-btn whatsapp-btn" onclick="shareOnWhatsApp()">
                <i class="fab fa-whatsapp"></i>
              </div>
              <div class="share-btn twitter-btn" onclick="shareOnTwitter()">
                <i class="fab fa-twitter"></i>
              </div>
              <div class="share-btn email-btn" onclick="shareViaEmail()">
                <i class="fas fa-envelope"></i>
              </div>
              <div class="share-btn copy-btn" onclick="openShareModal()">
                <i class="fas fa-link"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Comments Section -->
      <div class="lg:col-span-7 mobile-order-3">
        <div class="rounded-xl card compact">
          <div>
      
      <!-- Comment Form -->
<div class="mb-4 accent-bg p-3 rounded-xl accent-border border">
  <h3 class="text-sm font-medium mb-2 flex items-center gap-2">
    <i class="fas fa-comment-dots accent-color"></i>
    Add a Comment
  </h3>

  {% if user.is_authenticated %}
  <form method="post" action="{% url 'add_comment' ad.id %}" class="flex flex-col gap-2">
    {% csrf_token %}
    <!-- relative wrapper so we can position the button over the textarea -->
    <div class="relative">
      <textarea
        name="text"
        rows="3"
        class="w-full p-3 pr-28 bg-chip text-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-border placeholder-gray-500 resize-none" style="height: 73px;"
        placeholder="Write your comment..."
      ></textarea>

      <!-- positioned button that sits inside the textarea area -->
      <button
        type="submit"
        class="absolute right-2 bottom-2 gradient-btn text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-md"
      >
        <i class="fas fa-paper-plane"></i>
       
      </button>
    </div>
  </form>

  {% else %}
  <p class="text-sm">Please <a href="{% url 'login' %}" class="accent-color font-medium hover:underline">log in</a> to post a comment.</p>
  {% endif %}
</div>

            <!-- Comment List -->
            <div class="space-y-3">
              {% for comment in comments %}
              <div class="comment-card rounded-xl p-3 border border-gray-200" data-comment-id="{{ comment.id }}">
                <div class="flex items-start gap-3">
                  <img src="{{ comment.user.avatar.url|default:'/static/images/avatar.svg' }}" 
                       class="w-10 h-10 rounded-full object-cover border-2 border-accent-border">
                  <div class="flex-1">
                    <div class="comment-header">
                      <div>
                        <p class="text-base font-semibold">@{{ comment.user.username }}</p>
                        <p class="text-xs accent-color">{{ comment.timestamp|timesince }} ago</p>
                      </div>
                      <div class="comment-actions">
                        {% if comment.user == request.user %}
                        <button class="delete-btn text-sm flex items-center gap-1" 
                                onclick="showDeleteModal('{{ comment.id }}')">
                          <i class="fas fa-trash-alt"></i>
                        </button>
                        {% endif %}
                        <a href="#" class="text-xs accent-color hover:opacity-80 flex items-center gap-1 reply-link" 
                           data-comment-id="{{ comment.id }}">
                          <i class="fas fa-reply"></i>
                    
                        </a>
                      </div>
                    </div>
                    
                    <p class="text-sm mt-2">{{ comment.text }}</p>
                    
                    <div class="reply-form mt-2 ml-3 pl-3 border-l-2 border-accent-border" id="reply-form-{{ comment.id }}" style="display: none;">
                      <form method="post" action="{% url 'reply_to_comment' comment.id %}" class="flex flex-col sm:flex-row sm:items-center gap-2 mt-2 max-w-[90%]">
                        {% csrf_token %}
                         <div class="relative">
      <textarea
        name="text"
        rows="3"
        class="w-full p-3 pr-28 bg-chip text-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-border placeholder-gray-500 resize-none" style="height: 73px;"
        placeholder="Write your comment..."
      ></textarea>

      <!-- positioned button that sits inside the textarea area -->
      <button
        type="submit"
        class="absolute right-2 bottom-2 gradient-btn text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-md"
      >
        <i class="fas fa-paper-plane"></i>
       
      </button>
                        </div>
                       
                      </form>
                    </div>
                    
                    <!-- Replies -->
                    {% for reply in comment.replies.all %}
                    <div class="accent-bg rounded-xl p-2 mt-2 ml-3 pl-3 border-l-2 border-accent-border reply" data-reply-id="{{ reply.id }}" style="margin-right: 30px;">
                      <div class="flex items-start gap-2">
                        <img src="{{ reply.user.avatar.url|default:'/static/images/avatar.svg' }}" 
                             class="w-8 h-8 rounded-full object-cover border border-accent-border">
                        <div class="flex-1">
                          <div class="comment-header">
                            <div>
                              <p class="text-sm font-semibold">@{{ reply.user.username }}</p>
                              <p class="text-xs accent-color">{{ reply.timestamp|timesince }} ago</p>
                            </div>
                            {% if reply.user == request.user %}
                            <button class="delete-btn text-sm flex items-center gap-1" 
                                    onclick="showDeleteModal('{{ reply.id }}')">
                              <i class="fas fa-trash-alt"></i>
                            </button>
                            {% endif %}
                          </div>
                          <p class="text-sm mt-1">{{ reply.text }}</p>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
              {% empty %}
              <div class="text-center py-5">
                <i class="fas fa-comment-slash text-gray-300 text-4xl mb-2"></i>
                <p class="">No comments yet. Be the first to comment!</p>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

      <!-- NEW: Similar Items Section -->
    <div class="mt-8 mobile-order-4" style="position: relative; top: -175px;">
      <div class="bg-gradient-to-b from-purple-50 to-transparent rounded-xl p-4 mb-6">
        <div class="text-center mb-5" style="margin-top: 159px;">
          <h2 class="text-2xl font-bold mb-1">You Might Also Like</h2>
          <p class="text-sm max-w-2xl mx-auto">Browse similar items based on your interests</p>
        </div>
        
        <div class="relative -mt-1">
          <div class="product-container flex overflow-x-auto pb-3 space-x-3 scroll-container">
            {% for item in similar_items %}
            <!-- Compact Product Card -->
            <div class="rounded-lg shadow overflow-hidden border border-gray-200 hover:shadow-md transition flex-shrink-0 w-56">
              <div class="relative">
                {% if item.images.first %}
                <a href="{% url 'product_detail' item.id %}">
                  <img src="{{ item.images.first.image.url }}" alt="{{ item.name }}" class="w-full h-40 object-cover">
                </a>
                {% else %}
                <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-40 flex items-center justify-center">
                  <i class="fas fa-image text-gray-400 text-3xl"></i>
                </div>
                {% endif %}
                
                {% if item.is_featured %}
                <span class="absolute top-1 left-1 bg-pink-500 text-white text-xs font-bold px-1.5 py-0.5 rounded">
                  Featured
                </span>
                {% endif %}
                
                <span class="absolute top-1 right-1 bg-black bg-opacity-70 text-white text-xs font-bold px-1.5 py-0.5 rounded">
                  ${{ item.price }}
                </span>
              </div>
              
              <div class="p-3">
                <h3 class="font-bold text-sm mb-1 truncate">
                  <a href="{% url 'product_detail' item.id %}" class="hover:accent-color transition">
                    {{ item.name }}
                  </a>
                </h3>
                
                <div class="flex items-center text-xs mb-1">
                  <i class="fas fa-map-marker-alt mr-1 text-xs accent-color"></i>
                  <span class="truncate">{{ item.location }}</span>
                </div>
                
                <div class="flex items-center text-xs">
                  <i class="far fa-clock mr-1 text-xs accent-color"></i>
                  <span>{{ item.created_at|timesince }} ago</span>
                </div>
                
                <div class="flex justify-between items-center mt-2">
                  <span class="text-xs bg-chip px-1.5 py-0.5 rounded">
                    {{ item.category.name }}
                  </span>
                  <a href="{% url 'product_detail' item.id %}" 
                     class="accent-color hover:opacity-80 font-medium text-xs">
                    View Details
                  </a>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="flex flex-col items-center justify-center w-full py-6">
              <i class="fas fa-box-open text-gray-300 text-4xl mb-3"></i>
              <p class="text-sm">No similar items found</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="rounded-xl p-5 shadow-lg max-w-sm w-full border border-gray-200">
      <div class="text-center mb-3">
        <i class="fas fa-exclamation-circle accent-color text-4xl mb-2"></i>
        <h3 class="text-lg font-semibold">Delete Comment</h3>
        <p class="text-sm mt-1">Are you sure you want to delete this comment?</p>
      </div>
      <div class="flex justify-center gap-2">
        <button id="cancel-delete" class="bg-chip px-4 py-2 rounded-lg text-sm font-medium hover:opacity-80 transition-colors">
          Cancel
        </button>
        <button id="confirm-delete" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors">
          Delete
        </button>
      </div>
    </div>
  </div>
  
  <!-- Share Modal -->
  <div class="share-modal" id="shareModal">
    <div class="share-modal-content">
      <div class="share-modal-header">
        <h3 class="share-modal-title">Share this ad</h3>
        <button class="share-modal-close" onclick="closeShareModal()">&times;</button>
      </div>
      <div class="share-input-group">
        <input type="text" id="shareableLink" class="share-input" value="{{ request.build_absolute_uri }}" readonly>
        <button class="copy-button" onclick="copyToClipboard()">
          <i class="fas fa-copy"></i>
        </button>
      </div>
      <div class="share-success" id="copySuccess">
        <i class="fas fa-check-circle mr-2"></i>
        Link copied to clipboard!
      </div>
      <div class="share-buttons justify-center mt-4">
        <div class="share-btn facebook-btn" onclick="shareOnFacebook()">
          <i class="fab fa-facebook-f"></i>
        </div>
        <div class="share-btn whatsapp-btn" onclick="shareOnWhatsApp()">
          <i class="fab fa-whatsapp"></i>
        </div>
        <div class="share-btn twitter-btn" onclick="shareOnTwitter()">
          <i class="fab fa-twitter"></i>
        </div>
        <div class="share-btn email-btn" onclick="shareViaEmail()">
          <i class="fas fa-envelope"></i>
        </div>
      </div>
    </div>
  </div>



  <script>
    // Image gallery functionality
    function changeMainImage(src, element) {
      document.getElementById('mainImage').src = src;
      
      // Remove active class from all thumbnails
      document.querySelectorAll('.gallery-thumb').forEach(thumb => {
        thumb.classList.remove('active');
      });
      
      // Add active class to clicked thumbnail
      element.classList.add('active');
    }
    
    document.querySelectorAll('.reply-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const commentId = this.getAttribute('data-comment-id');
        const form = document.getElementById(`reply-form-${commentId}`);
        if (form.style.display === 'none') {
          form.style.display = 'block';
          setTimeout(() => {
            form.classList.add('active');
          }, 10);
        } else {
          form.classList.remove('active');
          setTimeout(() => {
            form.style.display = 'none';
          }, 300);
        }
      });
    });
    
    // Delete modal functions
    let currentDeleteId = null;
    
    function showDeleteModal(id) {
      currentDeleteId = id;
      const modal = document.getElementById('delete-modal');
      modal.classList.remove('hidden');
    }
    
    document.getElementById('cancel-delete').addEventListener('click', function() {
      document.getElementById('delete-modal').classList.add('hidden');
      currentDeleteId = null;
    });
    
    document.getElementById('confirm-delete').addEventListener('click', function() {
      if (currentDeleteId) {
        const element = document.querySelector(`[data-comment-id="${currentDeleteId}"], [data-reply-id="${currentDeleteId}"]`);
        if (element) {
          element.remove();
        }
        document.getElementById('delete-modal').classList.add('hidden');
        currentDeleteId = null;
      }
    });
    
    // Share functionality
    function openShareModal() {
      document.getElementById('shareModal').classList.add('active');
    }
    
    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('active');
    }
    
    function getShareableLink() {
      return "{{ request.build_absolute_uri }}";
    }
    
    function getShareText() {
      return "Check out this ad: {{ ad.name }} on SomaliShoppe";
    }
    
    function shareOnFacebook() {
      const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(getShareableLink())}`;
      window.open(url, '_blank', 'width=600,height=400');
    }
    
    function shareOnWhatsApp() {
      const text = encodeURIComponent(`${getShareText()} - ${getShareableLink()}`);
      window.open(`https://wa.me/?text=${text}`, '_blank');
    }
    
    function shareOnTwitter() {
      const text = encodeURIComponent(getShareText());
      const url = encodeURIComponent(getShareableLink());
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=600,height=400');
    }
    
    function shareViaEmail() {
      const subject = encodeURIComponent("Check out this ad on SomaliShoppe");
      const body = encodeURIComponent(`${getShareText()}\n\n${getShareableLink()}`);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }
    
    function copyToClipboard() {
      const input = document.getElementById('shareableLink');
      input.select();
      document.execCommand('copy');
      
      // Show success message
      const success = document.getElementById('copySuccess');
      success.classList.add('active');
      
      // Hide after 2 seconds
      setTimeout(() => {
        success.classList.remove('active');
      }, 2000);
    }
    
    // Close modal when clicking outside content
    document.getElementById('shareModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeShareModal();
      }
    });
  </script>
</body>
</html>
{% endblock %}