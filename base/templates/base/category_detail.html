<!-- templates/category_detail.html -->
{% extends 'main.html' %}
{% load static %}

{% block content %}
<body class="antialiased">
    <main class="flex-1 overflow-auto p-3 md:p-6 scrollbar-thin">
      <section class="mb-4 md:mb-6">
        <div class="flex items-center justify-between">
          <h2 class="text-lg md:text-2xl font-semibold">{{ category.name }} - All Listings</h2>
        </div>

        <div class="mt-3 md:mt-4 flex flex-wrap gap-2 items-center">
          <input id="filterInput" class="rounded-md bg-slate-800 px-2 py-2 w-48 md:w-64 placeholder:text-[color:var(--muted)] text-sm" placeholder="Type to filter {{ category.name }} listings" />
          <div class="flex gap-2 flex-wrap">
            <button id="sortButton" class="px-2 py-1 rounded-full bg-[color:var(--chip)] text-[color:var(--muted)] text-xs md:text-sm">Display name â–¾</button>
          </div>
          <div class="ml-auto text-xs md:text-sm text-[color:var(--muted)] flex items-center gap-3">
            <span>Showing <strong id="assetCount">{{ ads|length }}</strong> listings in {{ category.name }}</span>   
            <a href="{% url 'create_ad_form' %}">
              <button class="px-2 py-1 rounded-md text-xs bg-sky-500 text-white hover:bg-sky-600 transition" style="width: 112px; height: 35px; font-family: arial; font-size: 13px;">Post Here</button>
            </a>     
          </div>
        </div>
      </section>

      <!-- Breadcrumb -->
      <div class="mb-4 text-sm text-[color:var(--muted)]">
        <a href="{% url 'index' %}" class="hover:text-white transition">Home</a>
        <span class="mx-2">/</span>
        <span class="text-white">{{ category.name }}</span>
      </div>

      <!-- Category Products Grid -->
      <section class="categories-section py-6 px-4 relative z-0">
        <div class="container mx-auto max-w-7xl">
          {% if ads %}
            <!-- If we have subcategories, display by subcategory in horizontal rows -->
            {% if subcategories %}
              {% for subcategory_name, subcategory_ads in subcategories.items %}
              <div class="mb-12 subcategory-section">
                <!-- Subcategory Header -->
                <div class="flex items-center justify-between mb-6 px-2">
                  <h3 class="text-xl font-semibold text-white">
                    {{ subcategory_name }} 
                    <span class="text-slate-400 text-sm ml-2">({{ subcategory_ads|length }} items)</span>
                  </h3>
              
                </div>
                
                <!-- Horizontal Scroll Container for this subcategory -->
                <div class="overflow-x-auto pb-6 scrollbar-thin scrollbar-thumb-slate-600 scrollbar-track-slate-800 drag-scroll" data-drag-scroll>
                  <div class="flex gap-6 min-w-max px-2 subcategory-row" data-subcategory="{{ subcategory_name|slugify }}">
                    {% for product in subcategory_ads %}
                    <div class="w-72 flex-shrink-0 product-card">
                      <article class="asset-card bg-slate-800 rounded-lg shadow-lg overflow-hidden border border-slate-700 hover:border-slate-500 transition-all duration-300 h-full flex flex-col" data-name="{{ product.name|lower }}" data-location="{{ product.location|default:''|lower }}">
                        <a href="{% url 'product_detail' product.id %}" class="block flex-grow">
                          <div class="product-image-container relative h-48">
                            {% if product.images.first %}
                            <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" class="product-image w-full h-full object-cover transition-transform duration-300 hover:scale-105" loading="lazy" draggable="false">
                            {% else %}
                            <div class="product-placeholder w-full h-full bg-slate-700 flex items-center justify-center">
                              <i class="fas fa-image text-4xl text-slate-500"></i>
                            </div>
                            {% endif %}

                            {% if product.is_featured %}
                            <span class="absolute top-2 left-2 bg-pink-500 text-white text-xs font-bold px-2 py-1 rounded-md">Featured</span>
                            {% endif %}

                            <span class="absolute top-2 right-2 bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded-md">${{ product.price }}</span>
                          </div>
                          
                          <div class="p-4 flex-grow">
                            <div class="flex items-start justify-between gap-3">
                              <div class="w-full">
                                <h3 class="font-semibold text-white mb-2 product-name line-clamp-2 leading-tight">{{ product.name }}</h3>
                                <div class="text-xs text-slate-400 mb-2 flex items-center">
                                  <i class="fas fa-map-marker-alt mr-1 w-4"></i>
                                  <span class="truncate">{{ product.location|default:"No location" }}</span>
                                </div>
                                <div class="text-xs text-slate-400 mb-3 flex items-center">
                                  <i class="far fa-clock mr-1 w-4"></i>
                                  <span>{{ product.created_at|timesince }} ago</span>
                                </div>
                                <div class="mt-3 flex items-center justify-between">
                                  <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">{{ product.category.name }}</span>
                                  <a href="{% url 'product_detail' product.id %}" class="px-3 py-2 rounded-md bg-sky-500 text-white text-xs font-medium hover:bg-sky-600 transition">View Details</a>
                                </div>
                              </div>
                            </div>
                          </div>
                        </a>
                      </article>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
              {% endfor %}
            
            <!-- If no subcategories, display all ads in one horizontal row -->
            {% else %}
              <div class="mb-12">
                <!-- Category Header -->
                <div class="flex items-center justify-between mb-6 px-2">
                  <h3 class="text-xl font-semibold text-white">
                    All {{ category.name }} 
                    <span class="text-slate-400 text-sm ml-2">({{ ads|length }} items)</span>
                  </h3>
                  {% if ads|length > 4 %}
                  <button class="text-sky-500 text-sm hover:text-sky-400 transition font-medium" id="viewAllToggle">
                    View All
                  </button>
                  {% endif %}
                </div>
                
                <!-- Horizontal Scroll Container -->
                <div class="overflow-x-auto pb-6 scrollbar-thin scrollbar-thumb-slate-600 scrollbar-track-slate-800 drag-scroll" data-drag-scroll>
                  <div class="flex gap-6 min-w-max px-2" id="productsContainer">
                    {% for product in ads %}
                    <div class="w-72 flex-shrink-0 product-card">
                      <article class="asset-card bg-slate-800 rounded-lg shadow-lg overflow-hidden border border-slate-700 hover:border-slate-500 transition-all duration-300 h-full flex flex-col" data-name="{{ product.name|lower }}" data-location="{{ product.location|default:''|lower }}">
                        <a href="{% url 'product_detail' product.id %}" class="block flex-grow">
                          <div class="product-image-container relative h-48">
                            {% if product.images.first %}
                            <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" class="product-image w-full h-full object-cover transition-transform duration-300 hover:scale-105" loading="lazy" draggable="false">
                            {% else %}
                            <div class="product-placeholder w-full h-full bg-slate-700 flex items-center justify-center">
                              <i class="fas fa-image text-4xl text-slate-500"></i>
                            </div>
                            {% endif %}

                            {% if product.is_featured %}
                            <span class="absolute top-2 left-2 bg-pink-500 text-white text-xs font-bold px-2 py-1 rounded-md">Featured</span>
                            {% endif %}

                            <span class="absolute top-2 right-2 bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded-md">${{ product.price }}</span>
                          </div>
                          
                          <div class="p-4 flex-grow">
                            <div class="flex items-start justify-between gap-3">
                              <div class="w-full">
                                <h3 class="font-semibold text-white mb-2 product-name line-clamp-2 leading-tight">{{ product.name }}</h3>
                                <div class="text-xs text-slate-400 mb-2 flex items-center">
                                  <i class="fas fa-map-marker-alt mr-1 w-4"></i>
                                  <span class="truncate">{{ product.location|default:"No location" }}</span>
                                </div>
                                <div class="text-xs text-slate-400 mb-3 flex items-center">
                                  <i class="far fa-clock mr-1 w-4"></i>
                                  <span>{{ product.created_at|timesince }} ago</span>
                                </div>
                                <div class="mt-3 flex items-center justify-between">
                                  <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">{{ product.category.name }}</span>
                                  <a href="{% url 'product_detail' product.id %}" class="px-3 py-2 rounded-md bg-sky-500 text-white text-xs font-medium hover:bg-sky-600 transition">View Details</a>
                                </div>
                              </div>
                            </div>
                          </div>
                        </a>
                      </article>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}

          {% else %}
            <div class="text-center py-12">
              <div class="text-6xl text-slate-600 mb-4">
                <i class="fas fa-folder-open"></i>
              </div>
              <h3 class="text-xl font-semibold text-white mb-2">No listings in {{ category.name }}</h3>
              <p class="text-slate-400 mb-6">Be the first to post in this category!</p>
              <a href="{% url 'create_ad_form' %}" class="px-6 py-3 rounded-md bg-sky-500 text-white font-medium hover:bg-sky-600 transition">
                Post Your First Ad
              </a>
            </div>
          {% endif %}
        </div>
      </section>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const filterInput = document.getElementById('filterInput');
        const sortButton = document.getElementById('sortButton');
        const viewAllToggle = document.getElementById('viewAllToggle');
        const productsContainer = document.getElementById('productsContainer');
        
        let sortAscending = false;
        let isGridView = false;

        // Mouse drag scrolling functionality
        function initializeDragScroll() {
          const sliders = document.querySelectorAll('[data-drag-scroll]');
          
          sliders.forEach(slider => {
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
              isDown = true;
              slider.classList.add('active');
              startX = e.pageX - slider.offsetLeft;
              scrollLeft = slider.scrollLeft;
            });

            slider.addEventListener('mouseleave', () => {
              isDown = false;
              slider.classList.remove('active');
            });

            slider.addEventListener('mouseup', () => {
              isDown = false;
              slider.classList.remove('active');
            });

            slider.addEventListener('mousemove', (e) => {
              if (!isDown) return;
              e.preventDefault();
              const x = e.pageX - slider.offsetLeft;
              const walk = (x - startX) * 2; // Scroll speed multiplier
              slider.scrollLeft = scrollLeft - walk;
            });

            // Prevent image dragging inside the slider
            slider.querySelectorAll('img').forEach(img => {
              img.addEventListener('dragstart', (e) => {
                e.preventDefault();
              });
            });
          });
        }

        // Initialize drag scrolling
        initializeDragScroll();
        
        // Filter function
        function filterProducts(keyword) {
          const searchTerm = keyword.toLowerCase().trim();
          let visibleCount = 0;
          
          document.querySelectorAll('.asset-card').forEach(card => {
            const productName = card.querySelector('.product-name').textContent.toLowerCase();
            const productLocation = card.getAttribute('data-location');
            
            const matches = productName.includes(searchTerm) || 
                           productLocation.includes(searchTerm);
            
            if (searchTerm === '' || matches) {
              card.style.display = 'block';
              card.closest('.product-card').style.display = 'block';
              visibleCount++;
            } else {
              card.style.display = 'none';
              card.closest('.product-card').style.display = 'none';
            }
          });
          
          document.getElementById('assetCount').textContent = visibleCount;
        }
        
        // Sort function for individual subcategory rows
        function sortSubcategoryRows() {
          sortAscending = !sortAscending;
          sortButton.textContent = `Display name ${sortAscending ? 'â–´' : 'â–¾'}`;
          
          // Sort within each subcategory row
          document.querySelectorAll('.subcategory-row').forEach(container => {
            const cardWrappers = Array.from(container.querySelectorAll('.product-card'));
            
            cardWrappers.sort((a, b) => {
              const nameA = a.querySelector('.product-name').textContent.toLowerCase();
              const nameB = b.querySelector('.product-name').textContent.toLowerCase();
              
              return sortAscending ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
            });
            
            // Re-append card wrappers in sorted order
            cardWrappers.forEach(wrapper => {
              container.appendChild(wrapper);
            });
          });
          
          // Also sort the main products container if it exists
          if (productsContainer) {
            const mainCardWrappers = Array.from(productsContainer.querySelectorAll('.product-card'));
            
            mainCardWrappers.sort((a, b) => {
              const nameA = a.querySelector('.product-name').textContent.toLowerCase();
              const nameB = b.querySelector('.product-name').textContent.toLowerCase();
              
              return sortAscending ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
            });
            
            mainCardWrappers.forEach(wrapper => {
              productsContainer.appendChild(wrapper);
            });
          }
        }
        
        // Toggle between horizontal scroll and grid view for main container
        function toggleView() {
          if (!productsContainer) return;
          
          isGridView = !isGridView;
          
          if (isGridView) {
            productsContainer.classList.remove('flex', 'gap-6', 'min-w-max', 'overflow-x-auto');
            productsContainer.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', 'gap-6');
            viewAllToggle.textContent = 'Horizontal View';
          } else {
            productsContainer.classList.remove('grid', 'grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', 'gap-6');
            productsContainer.classList.add('flex', 'gap-6', 'min-w-max');
            viewAllToggle.textContent = 'Grid View';
          }
        }
        
        // View All button functionality for subcategories
        document.querySelectorAll('.view-all-btn').forEach(button => {
          button.addEventListener('click', function() {
            const subcategory = this.getAttribute('data-subcategory');
            const row = document.querySelector(`.subcategory-row[data-subcategory="${subcategory}"]`);
            if (row) {
              row.classList.toggle('min-w-max');
              row.classList.toggle('flex-wrap');
              if (row.classList.contains('flex-wrap')) {
                this.textContent = 'Show Less';
              } else {
                this.textContent = 'View All';
              }
            }
          });
        });
        
        if (filterInput) {
          filterInput.addEventListener('input', function(e) {
            filterProducts(e.target.value);
          });
        }
        
        if (sortButton) {
          sortButton.addEventListener('click', sortSubcategoryRows);
        }
        
        if (viewAllToggle) {
          viewAllToggle.addEventListener('click', toggleView);
        }
      });
    </script>

    <style>
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      .scrollbar-thin::-webkit-scrollbar {
        height: 6px;
      }
      
      .scrollbar-thin::-webkit-scrollbar-track {
        background: #1e293b;
        border-radius: 3px;
      }
      
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 3px;
      }
      
      .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }

      /* Ensure each subcategory section is clearly separated */
      .subcategory-section {
        border-bottom: 1px solid #334155;
        padding-bottom: 2rem;
      }
      
      .subcategory-section:last-child {
        border-bottom: none;
      }

      /* Drag scrolling styles */
      .drag-scroll {
        cursor: grab;
        user-select: none;
      }
      
      .drag-scroll.active {
        cursor: grabbing;
      }
      
      .drag-scroll img {
        pointer-events: none;
      }
      
      .drag-scroll a {
        pointer-events: auto;
      }
    </style>
</body>
{% endblock %}