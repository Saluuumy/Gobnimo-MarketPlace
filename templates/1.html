{% extends 'main.html' %}
{% load static %}

{% block content %}
<body data-show-success="{{ show_success|yesno:'true,false' }}" class="bg-gray-100">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Navigation -->
        <div class="mb-8">
            <a href="{% url 'index' %}" class="inline-flex items-center text-gray-800 hover:text-indigo-500 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Categories
            </a>
        </div>

        <!-- Form Container -->
        <div class="bg-white rounded-2xl p-8 border-2 border-indigo-500 shadow-xl">
            <header class="mb-8 text-center">
                <div class="mb-4">
                    <div class="w-16 h-16 mx-auto bg-gradient-to-r from-indigo-500 to-amber-500 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </div>
                </div>
                <h1 class="text-3xl font-bold mb-3 text-gray-800">Create Featured Ad</h1>
                <p class="text-gray-600 text-lg">Showcase your product with premium visibility</p>
            </header>

            <form id="productForm" method="post" enctype="multipart/form-data" class="space-y-8">
                {% csrf_token %}

                <!-- Product Details -->
                <section class="bg-gray-50 p-6 rounded-xl border border-indigo-500">
                    <h2 class="text-xl font-bold mb-6 text-center border-b border-indigo-500 pb-2 text-gray-800">
                        <span class="px-4 py-1 rounded-full">Product Details</span>
                    </h2>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-amber-500" ...></svg>
                                Product Name
                            </label>
                            {{ form.name }}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-800 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-amber-500" ...></svg>
                                    Price
                                </label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-800">$</span>
                                    {{ form.price }}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-800 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-amber-500" ...></svg>
                                    Location
                                </label>
                                {{ form.location }}
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-amber-500" ...></svg>
                                Condition
                            </label>
                            {{ form.condition }}
                        </div>
                    </div>
                </section>

                <!-- Category Specific -->
                {% if category.name == 'Cars' or category.name == 'Guri' %}
                <section class="bg-gray-50 p-6 rounded-xl border border-indigo-500">
                    <h2 class="text-xl font-bold mb-6 text-center border-b border-indigo-500 pb-2 text-gray-800">
                        <span class="px-4 py-1 rounded-full">Category Details</span>
                    </h2>
                    <div class="space-y-5">
                        {% if category.name == 'Cars' %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-800 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-amber-500" ...></svg>
                                    Motor Type
                                </label>
                                {{ form.motortype }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-800 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-amber-500" ...></svg>
                                    Year
                                </label>
                                {{ form.year }}
                            </div>
                        </div>
                        {% elif category.name == 'Guri' %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-800 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-amber-500" ...></svg>
                                    Rooms
                                </label>
                                {{ form.num_rooms }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-800 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-amber-500" ...></svg>
                                    Baths
                                </label>
                                {{ form.num_baths }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </section>
                {% endif %}

                <!-- Description -->
                <section class="bg-gray-50 p-6 rounded-xl border border-indigo-500">
                    <h2 class="text-xl font-bold mb-6 text-center border-b border-indigo-500 pb-2 text-gray-800">
                        <span class="px-4 py-1 rounded-full">Product Description</span>
                    </h2>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-gray-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-amber-500" ...></svg>
                                Product Story
                            </label>
                            {{ form.description }}
                        </div>
                    </div>
                </section>

                <!-- Image Upload -->
                <section class="bg-gray-50 p-6 rounded-xl border border-indigo-500">
                    <h2 class="text-xl font-bold mb-6 text-center border-b border-indigo-500 pb-2 text-gray-800">
                        <span class="px-4 py-1 rounded-full">Product Gallery</span>
                    </h2>
                    <div class="space-y-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Upload Your Images</h3>
                            <button type="button" id="addImageBtn" class="flex items-center text-sm bg-indigo-500 px-4 py-2 rounded-lg hover:bg-indigo-600 transition-all text-white">
                                <svg class="w-5 h-5 mr-2" ...></svg>
                                Add Images
                            </button>
                        </div>
                        <div id="imageInputContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        <div id="previewContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                            <div class="preview-card relative group rounded-xl overflow-hidden border-2 border-dashed border-indigo-500 h-48 flex items-center justify-center">
                                <svg class="w-12 h-12 text-indigo-500" ...></svg>
                                <p class="text-gray-800 text-sm mt-2">Upload Preview</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Submit -->
                <div class="mt-8 text-center">
                    <button type="submit" class="w-full py-4 bg-indigo-500 rounded-xl font-bold text-white hover:bg-indigo-600 transition-all transform hover:scale-[1.02] shadow-lg hover:shadow-indigo-500/30 flex items-center justify-center gap-2">
                        <svg class="w-6 h-6" ...></svg>
                        Launch Featured Ad
                    </button>
                </div>
            </form>
        </div>

        <!-- Success Modal -->
        <div id="successModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 border-2 border-indigo-500 relative">
                <!-- Confetti -->
                <div class="absolute w-4 h-4 top-10 left-10 bg-indigo-500 rounded-full animate-pulse"></div>
                <div class="absolute w-3 h-3 top-20 right-12 bg-amber-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                <div class="absolute w-5 h-5 bottom-16 left-16 bg-indigo-600 rounded-full animate-pulse" style="animation-delay: 1s;"></div>

                <div class="text-center relative z-10">
                    <div class="w-20 h-20 mx-auto mb-6 bg-indigo-500 rounded-full flex items-center justify-center">
                        <svg class="w-10 h-10 text-white" ...></svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Success!</h3>
                    <p class="text-gray-600 mb-6">Your featured ad is now in review. Get ready to shine!</p>
                    <a href="{% url 'index' %}" class="inline-block bg-indigo-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-600 transition-all">
                        Return to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>



    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Style form inputs with lighter border color
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.classList.add(
                    'w-full', 'px-4', 'py-3', 'bg-white', 
                    'border', 'border-[#d8b4fe]', 'rounded-lg', 
                    'text-[#0f172a]', 'focus:outline-none', 'focus:ring-2', 
                    'focus:ring-[#9333ea]', 'focus:border-transparent'
                );
            });

            const handleImageUpload = (input) => {
                const file = input.files[0];
                if (file) {
                    const previewContainer = document.getElementById('previewContainer');
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const preview = document.createElement('div');
                        preview.className = 'preview-card relative group rounded-xl overflow-hidden h-48 border border-[#9333ea]';
                        preview.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-3">
                                <span class="text-white text-xs truncate">${file.name}</span>
                            </div>
                            <button type="button" class="absolute top-2 right-2 bg-[#9333ea]/80 hover:bg-[#9333ea] p-1 rounded-full transition-colors">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        `;
                        
                        preview.querySelector('button').addEventListener('click', () => {
                            preview.remove();
                            if (previewContainer.children.length === 0) {
                                previewContainer.innerHTML = `
                                    <div class="preview-card relative group rounded-xl overflow-hidden border-2 border-dashed border-[#9333ea] h-48 flex items-center justify-center">
                                        <svg class="w-12 h-12 text-[#9333ea]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        <p class="text-[#0f172a] text-sm mt-2">Upload Preview</p>
                                    </div>
                                `;
                            }
                        });
                        
                        if (previewContainer.querySelector('.border-dashed')) {
                            previewContainer.innerHTML = '';
                        }
                        
                        previewContainer.appendChild(preview);
                    };
                    reader.readAsDataURL(file);
                    input.parentElement.remove();
                }
            };

            const addNewImageInput = () => {
                const imageInputContainer = document.getElementById('imageInputContainer');
                const inputGroup = document.createElement('div');
                inputGroup.className = 'image-input-group';
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.name = 'images';
                input.className = 'w-full px-4 py-3 bg-white border border-[#d8b4fe] rounded-lg text-[#0f172a] focus:outline-none focus:ring-2 focus:ring-[#9333ea] file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-[#9333ea] file:text-white hover:file:bg-[#7c3aed] transition-colors';
                input.multiple = false;
                input.addEventListener('change', (e) => handleImageUpload(e.target));
                inputGroup.appendChild(input);
                imageInputContainer.appendChild(inputGroup);
            };

            document.getElementById('addImageBtn')?.addEventListener('click', () => {
                addNewImageInput();
            });

            addNewImageInput();

            if (document.body.dataset.showSuccess === 'true') {
                const successModal = document.getElementById('successModal');
                successModal.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
{% endblock %}



from django.db import models
from django.contrib.auth.models import AbstractUser ,BaseUserManager
from django.utils import timezone

class CustomUserManager(BaseUserManager):
    def create_user(self, email, password=None, **extra_fields):
        if not email:
            raise ValueError('The Email field must be set')
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password=None, **extra_fields):
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)

        if extra_fields.get('is_staff') is not True:
            raise ValueError('Superuser must have is_staff=True.')
        if extra_fields.get('is_superuser') is not True:
            raise ValueError('Superuser must have is_superuser=True.')

        return self.create_user(email, password, **extra_fields)

class User(AbstractUser):
    full_name = models.CharField(max_length=200, null=True)
    email = models.EmailField(max_length=200, unique=True)
    bio = models.TextField(null=True)
    phone_number = models.CharField(max_length=15, null=True, blank=True, unique=True)
    avatar = models.ImageField(null=True, default="avatar.svg")
    location = models.CharField(max_length=255, blank=True, help_text="City or region (e.g., Hargeisa)")
    email_verified = models.BooleanField(default=False)

    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = []

    objects = CustomUserManager()

    def __str__(self):
        return self.email
    
class Category(models.Model):
    name = models.CharField(max_length=100)
    parent_category = models.ForeignKey(
        'self', null=True, blank=True, related_name='subcategories', on_delete=models.CASCADE
    )
    image = models.ImageField(upload_to='images')

    def __str__(self):
        return self.name



class Ad(models.Model):
    STATUS_CHOICES = (
        ('pending', 'Pending'),
        ('approved', 'Approved'),
        ('rejected', 'Rejected'),
    )

    advertiser = models.ForeignKey(User, on_delete=models.CASCADE)
    category = models.ForeignKey(Category, on_delete=models.CASCADE)
    name = models.CharField(max_length=255)
    price = models.DecimalField(max_digits=10, decimal_places=2)
    location = models.CharField(max_length=255)
    condition = models.CharField(max_length=100, blank=True)
    description = models.TextField(blank=True)
    views = models.PositiveIntegerField(default=0)


    # Dynamic fields
    motortype = models.CharField(max_length=100, blank=True, null=True)
    geartype = models.CharField(max_length=100, blank=True, null=True)
    year = models.PositiveIntegerField(blank=True, null=True)
    color = models.CharField(max_length=50, blank=True, null=True)
    num_rooms = models.PositiveIntegerField(blank=True, null=True)
    num_baths = models.PositiveIntegerField(blank=True, null=True)

    # Status flags
    is_approved = models.BooleanField(default=False)
    is_featured = models.BooleanField(default=False)
    status = models.CharField(max_length=10, choices=STATUS_CHOICES, default='pending')

    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.name

    def is_currently_featured(self):
        return hasattr(self, 'featuredad') and self.featuredad.is_active()

    class Meta:
        indexes = [
            models.Index(fields=["is_featured"]),
            models.Index(fields=["status"]),
        ]


class FeaturedAd(models.Model):
    ad = models.OneToOneField(Ad, on_delete=models.CASCADE, related_name='featuredad')
    payment_screenshot = models.ImageField(upload_to='payment_screenshots/')
    featured_start_date = models.DateTimeField(default=timezone.now)
    featured_expiry_date = models.DateTimeField()

    def save(self, *args, **kwargs):
        if not self.ad.is_approved:
            raise ValueError(f"Cannot create FeaturedAd for unapproved ad: {self.ad.name}")
        super().save(*args, **kwargs)

    def is_active(self):
        now = timezone.now()
        return self.featured_start_date <= now <= self.featured_expiry_date

    def __str__(self):
        return f"{self.ad.name} featured until {self.featured_expiry_date}"


class FeaturedAdHistory(models.Model):
    ad = models.ForeignKey(Ad, on_delete=models.CASCADE, related_name='featured_history')
    amount_paid = models.DecimalField(max_digits=10, decimal_places=2)
    payment_screenshot = models.ImageField(upload_to='payment_screenshots/')
    featured_date = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField()

    def __str__(self):
        return f"{self.ad.name} featured until {self.expires_at}"


class PendingFeaturedAd(models.Model):
    ad = models.OneToOneField(Ad, on_delete=models.CASCADE, related_name='pending_featured')
    payment_screenshot = models.ImageField(upload_to='payment_screenshots/')
    featured_start_date = models.DateTimeField()
    featured_expiry_date = models.DateTimeField()

    def __str__(self):
        return f"Pending feature for {self.ad.name}"


class AdImage(models.Model):
    ad = models.ForeignKey(Ad, on_delete=models.CASCADE, related_name='images')
    image = models.ImageField(upload_to='images')

    def __str__(self):
        return f"Image for {self.ad.name}"


class Comment(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    ad = models.ForeignKey(Ad, on_delete=models.CASCADE, related_name='comments')
    text = models.TextField()
    timestamp = models.DateTimeField(auto_now_add=True)
    parent = models.ForeignKey('self', null=True, blank=True, on_delete=models.CASCADE, related_name='replies')

    def __str__(self):
        return f"Comment by {self.user.username} on {self.ad.name}"



